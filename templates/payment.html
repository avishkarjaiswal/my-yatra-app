{% extends 'base.html' %}

{% block step_indicator %}
<div class="step-indicator-container">
    <div class="container">
        <div class="step-indicator">
            <div class="step-item completed">
                <div class="step-circle">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <div class="step-label">Registration</div>
            </div>
            <div class="step-item completed">
                <div class="step-circle">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <div class="step-label">Package Selection</div>
            </div>
            <div class="step-item completed">
                <div class="step-circle">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <div class="step-label">Review Summary</div>
            </div>
            <div class="step-item active">
                <div class="step-circle">
                    <i class="bi bi-credit-card"></i>
                </div>
                <div class="step-label">Payment</div>
            </div>
            <div class="step-item">
                <div class="step-circle">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="step-label">Confirmation</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<section class="py-5 mt-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card glassmorphism p-5">
                    <h2 class="text-center mb-4">Payment Summary</h2>

                    <div class="border rounded p-4 mb-4 bg-light text-dark">
                        <h5 class="text-center mb-3 text-primary">Booking Details</h5>

                        <div class="row mb-3">
                            <div class="col-6 fw-bold">Number of Travelers:</div>
                            <div class="col-6">{{ travelers|length }}</div>
                        </div>

                        <div class="mb-3">
                            <strong class="d-block mb-2">Travelers & Package Details:</strong>
                            {% for traveler in travelers %}
                            <div class="card mb-2 border-primary">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-primary mb-2">
                                        <i class="bi bi-person-fill"></i> {{ traveler.name }}
                                        <small class="text-muted">({{ traveler.age }} yrs, {{ traveler.gender
                                            }})</small>
                                    </h6>
                                    <div class="row g-1 small">
                                        {% if traveler.journey_start_date %}
                                        <div class="col-6"><i class="bi bi-calendar-range"></i> Journey:</div>
                                        <div class="col-6">{{ traveler.journey_start_date }} to {{
                                            traveler.journey_end_date }} ({{ traveler.num_days }} days)</div>
                                        {% endif %}

                                        {% if traveler.hotel_category %}
                                        <div class="col-6"><i class="bi bi-building"></i> Hotel:</div>
                                        <div class="col-6">{{ traveler.hotel_category|capitalize }}</div>
                                        {% endif %}

                                        <div class="col-6"><i class="bi bi-egg-fried"></i> Food:</div>
                                        <div class="col-6">Premium</div>

                                        {% if traveler.travel_medium %}
                                        <div class="col-6"><i class="bi bi-train-front"></i> Travel:</div>
                                        <div class="col-6">
                                            {{ traveler.travel_medium|capitalize }}
                                            {% if traveler.travel_medium in ['train', 'flight'] %}
                                            <small class="text-muted">(Delhi to Dwarka)</small>
                                            {% endif %}
                                        </div>
                                        {% endif %}

                                        {% if traveler.has_otm and traveler.otm_id %}
                                        <div class="col-6"><i class="bi bi-card-checklist"></i> OTM:</div>
                                        <div class="col-6 text-success">Yes (Verified) - {{ traveler.otm_id }}</div>
                                        {% endif %}

                                        <div class="col-6 fw-bold mt-2">Amount:</div>
                                        <div class="col-6 fw-bold text-success mt-2">₹{{ traveler.amount|round|int }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-6 fw-bold fs-5">Total Amount:</div>
                            <div class="col-6 fw-bold fs-5 text-success">₹{{ total_amount }}</div>
                        </div>
                    </div>

                    <div class="d-grid">
                        <button id="razorpay-button" class="btn btn-success btn-lg">
                            <i class="bi bi-lock-fill me-2"></i>Pay ₹{{ total_amount }} with Razorpay
                        </button>
                    </div>

                    <div class="text-center mt-3">
                        <small class="text-white">
                            <i class="bi bi-shield-check me-1"></i>
                            Secure payment powered by Razorpay
                        </small>
                    </div>

                    <!-- Processing Message (hidden by default) -->
                    <div id="processing-message" class="alert alert-warning mt-4" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div>
                                <strong>Payment Successful!</strong><br>
                                <small>Please wait while we generate your receipt. <strong>DO NOT REFRESH</strong> or
                                    close this page.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    // Define the payment function globally so it's easy to access/debug
    function startPayment() {
        const button = document.getElementById('razorpay-button');
        const processingMsg = document.getElementById('processing-message');

        // Disable button to prevent double clicks
        button.disabled = true;

        var options = {
            "key": "{{ razorpay_key }}",
            "amount": parseInt("{{ (total_amount * 100) | int }}"), // Amount in paise
            "currency": "INR",
            "name": "Dwarka Yatra",
            "description": "Yatra Registration Payment",
            "order_id": "{{ order_id }}",

            // Payment Success Handler
            "handler": function (response) {
                // Show processing message immediately
                processingMsg.style.display = 'block';

                // Send payment details to backend for verification
                fetch("{{ url_for('verify_payment') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature,
                        session_order_ids: "{{ session_order_ids }}"
                    })
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            window.location.href = data.redirect_url;
                        } else {
                            throw new Error(data.error || 'Verification failed');
                        }
                    })
                    .catch(error => {
                        console.error('Payment Verification Error:', error);
                        processingMsg.style.display = 'none';
                        button.disabled = false;
                        alert('Payment successful, but verification failed: ' + error.message + '\nPlease contact support.');
                    });
            },

            // User Information for Razorpay Popup
            "prefill": {
                "name": "{{ travelers[0].name }}",
                "email": "{{ travelers[0].email or '' }}",
                "contact": "{{ travelers[0].phone or '' }}"
            },

            // UI Customization
            "theme": {
                "color": "#198754"
            },

            // Handle Payment Cancellation (User closes popup)
            "modal": {
                "ondismiss": function () {
                    button.disabled = false;
                    alert('Payment cancelled via modal close.');
                }
            }
        };

        // Initialize and open Razorpay
        var rzp = new Razorpay(options);

        // Handle failure at initialization level
        rzp.on('payment.failed', function (response) {
            button.disabled = false;
            alert("Payment Failed: " + response.error.description);
        });

        rzp.open();
    }

    // Attach click event
    document.getElementById('razorpay-button').addEventListener('click', function (e) {
        e.preventDefault();
        startPayment();
    });
</script>
{% endblock %}